<link rel="import" href="../polymer/polymer.html">
<script src="../jquery/dist/jquery.min.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>

<dom-module id="highcharts-chart">
    <template>
        <style>:host {width: 100%;display: inline-block}</style>
        <div id="Chart" width="100%" on-click="_checkSelected"></div>
    </template>
    <script>
        'use strict';
        Highcharts.setOptions({global: {useUTC: false}});
        Polymer({
            is: "highcharts-chart",
            properties: {
                type: {type: String, value: 'spline'},
                title: {type: String, value: "Highcharts Chart", observer: "_titleUpdate"},
                subtitle: {type: String, value: "", observer: "_subtitleUpdate"},
                showAxes: {type: Array, value: ()=>{return ['bottom','left']}},
                credits: {type: Boolean, value: false, reflectToAttribute:true},
                legend: {type: Boolean, value: false},
                chartOptions: {type: Object, value: ()=>{return {}}, observer: "_xAxisUpdate"},
                xAxis: {type: Object, value: ()=>{return {}}, observer: "_xAxisUpdate"},
                yLabel: {type: String, value: "Y-Axis"},
                label: {type: String, value: ""},
                data: {type: Array, value: ()=>{return []}, observer:"setData"},
                vsTime: {type: Boolean, value: false},
                loading: {type: Boolean, value: false, observer: "_loadingUpdate", reflectToAttribute:true},
                loadingMessage: {type: String, value: ""},
                selected: {type: Boolean, value: false, readOnly: true, notify: true, reflectToAttribute: true},
                selectedPoints: {type: Array, readOnly: true, notify: true},
                hideLabels: {type: Boolean, value: false, reflectToAttribute: true},
                export: {type: Boolean, value: false, reflectToAttribute: true},
                //Custom Chart Declarations
                legendHorizAlign: {type: String, value: "right"},
                legendVertAlign: {type: String, value: "top"},
                legendPos: {type: Object, value: ()=>{return {x: -40,y: 80}}},
                legendOptions: {type: Object, value: ()=>{return {}}},
                tooltipOptions: {type: Object, value: ()=>{return {}}},
                _chart: {type: Object, readOnly: true}},
            ready: function() {
                var xAxis = $.extend(this.vsTime?{type: 'datetime',tickPixelInterval: 150}:{},this.xAxis);
                switch (this.type) {
                    case 'spline': Series = [{name: this.yLabel,data: this.data}];break
                    case 'pie': Series = [{name: (this.label||this.yLabel),colorByPoint: true,data: this.data}];break
                }
                this._set_chart(new Highcharts.Chart({
                    chart: {
                        renderTo: this.$.Chart,
                        defaultSeriesType: this.type,
                        animation: Highcharts.svg, // don't animate in old IE
                        marginRight: 10,
                    },
                    click: function(e){},
                    title: {text: this.title},
                    subtitle: {text: this.subtitle},
                    xAxis: xAxis,
                    credits: this.credits,
                    plotOptions: {
                        pie: $.extend({
                            allowPointSelect: true,
                            cursor: 'pointer',
                            dataLabels: {
                                enabled: true,
                                format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                                style: {color: (Highcharts.theme && Highcharts.theme.contrastTextColor)||'black'}
                            }
                        }, chartOptions)
                    },
                    yAxis: {
                        title: {text: (this.label||this.yLabel)},
                        plotLines: [{value: 0,width: 1,color: '#808080'}]
                    },
                    tooltip: $.extend(this.vsTime?{formatter: function () {
                            return '<b>' + this.series.name + '</b><br/>' +
                                Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) + '<br/>' +
                                Highcharts.numberFormat(this.y, 2);
                        }}:{},this.tooltipOptions),
                    legend: $.extend({enabled: this.legend, layout: "vertical", verticalAlign: this.legendVertAlign, align: this.legendHorizAlign, x: this.legendPos.x, y: this.legendPos.y, backgroundColor: ((Highcharts.theme && Highcharts.theme.legendBackgroundColor) || '#FFFFFF'), shadow: true},legendOptions),
                    exporting: {enabled: this.export},
                    series: []
                }))
                this.async(()=>{this._loadingUpdate();window.dispatchEvent(new Event('resize'))},50)
            },
            setData: function(x,z) {if(this._chart){this._chart.series[(z||0)].setData(x)}},
            addData: function(x,y,z) {this.pushData(x,y,z,true)},
            pushData: function(x,y,z,append) {
                this._chart.series[(z||0)].addPoint([x,y],true,!append)
            },
            addSeries: function(name,data) {this._chart.addSeries({name: name, data: (data||[])},true)},
            updateSeries: function(data,z) {this._chart.series[(z||0)].update(data)},
            resizeChart: function() {this._chart.setSize(this.offsetWidth,this.offsetHeight)},
            destroy: function() {this._chart.destroy()},
            _checkSelected: function() {if(!this._chart){return};var points = this._chart.getSelectedPoints();this._setSelected(!!points.length);this._setSelectedPoints(points)},
            _xAxisUpdate: function() {if(!this._chart){return};this._chart.xAxis[0].update(this.xAxis)},
            _titleUpdate: function() {if(!this._chart){return};this._chart.setTitle({text: this.title})},
            _loadingUpdate: function() {if(!this._chart){return};this._chart[(this.loading?"show":"hide")+"Loading"](this.loadingMessage)},
            _subtitleUpdate: function() {if(!this._chart){return};this._chart.setTitle(null,{text: this.subtitle})}
        });
    </script>
</dom-module>
