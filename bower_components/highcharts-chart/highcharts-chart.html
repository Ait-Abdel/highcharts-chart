<link rel="import" href="../polymer/polymer.html">
<script src="../jquery/dist/jquery.min.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>

<dom-module id="highcharts-chart">
    <template>
        <style>:host {width: 100%;display: inline-block}</style>
        <div id="Chart" width="100%"></div>
    </template>
    <script>
        'use strict';
        Highcharts.setOptions({global: {useUTC: false}});
        Polymer({
            is: "highcharts-chart",
            properties: {
                type: {type: String, value: 'spline'},
                title: {type: String, value: "Highcharts Chart", observer: "_titleUpdate"},
                subtitle: {type: String, value: "", observer: "_subtitleUpdate"},
                showAxes: {type: Array, value: ['bottom','left']},
                credits: {type: Boolean, value: false, reflectToAttribute:true},
                legend: {type: Boolean, value: false},
                xAxis: {type: Object, value: {}},
                yLabel: {type: String, value: "Y-Axis"},
                label: {type: String, value: "Label"},
                data: {type: Array, value: [], observer:"setData"},
                vsTime: {type: Boolean, value: false},
                loading: {type: Boolean, value: true, observer: "_loadingUpdate", reflectToAttribute:true},
                loadingMessage: {type: String, value: ""},
                _chart: {type: Object, readOnly: true}},
            ready: function() {
                var Series = []
                var xAxis = this.vsTime?{type: 'datetime',tickPixelInterval: 150}:this.xAxis;
                var Tooltip = this.vsTime?{formatter: function () {
                        return '<b>' + this.series.name + '</b><br/>' +
                            Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) + '<br/>' +
                            Highcharts.numberFormat(this.y, 2);
                    }}:{};
                switch (this.type) {
                    case 'spline': Series = [{name: this.yLabel,data: this.data}];break
                    case 'pie': Series = [{name: (this.yLabel||this.label),colorByPoint: true,data: this.data}];break
                }
                this._set_chart(new Highcharts.Chart({
                    chart: {
                        renderTo: this.$.Chart,
                        defaultSeriesType: this.type,
                        animation: Highcharts.svg, // don't animate in old IE
                        marginRight: 10,
                    },
                    title: {text: this.title},
                    subtitle: {text: this.subtitle},
                    xAxis: xAxis,
                    credits: this.credits,
                    plotOptions: {
                        pie: {
                            allowPointSelect: true,
                            cursor: 'pointer',
                            dataLabels: {
                                enabled: true,
                                format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                                style: {color: (Highcharts.theme && Highcharts.theme.contrastTextColor)||'black'}
                            }
                        }
                    },
                    yAxis: {
                        title: {text: this.yLabel},
                        plotLines: [{
                            value: 0,
                            width: 1,
                            color: '#808080'
                        }]
                    },
                    tooltip: Tooltip,
                    legend: {enabled: this.legend},
                    exporting: {enabled: false},
                    series: Series
                }))
                this.async(()=>{this._loadingUpdate();window.dispatchEvent(new Event('resize'))},50)
            },
            setData: function(x) {if(this._chart){this._chart.series[0].setData(x)}},
            addData: function(x,y) {this.pushData(x,y,true)},
            pushData: function(x,y,append) {
                switch (this.type) {
                    case 'spline': this._chart.series[0].addPoint([x,y],true,!append);break
                    case 'pie': this.setData(x);break
                }
            },
            _titleUpdate: function() {if(!this._chart){return};this._chart.setTitle({text: this.title})},
            _loadingUpdate: function() {if(!this._chart){return};this._chart[(this.loading?"show":"hide")+"Loading"](this.loadingMessage)},
            _subtitleUpdate: function() {if(!this._chart){return};this._chart.setSubtitle({text: this.subtitle})}
        });
    </script>
</dom-module>
